services:
  volume-init:
    image: alpine:latest
    container_name: hjaerna-volume-init
    volumes:
      - hjaerna-data:/data
    command: >
      sh -c "chown -R 1001:1001 /data &&
             chmod -R 755 /data &&
             echo 'Volume permissions initialized successfully'"
    networks:
      - traefik

  bot:
    container_name: hjaerna-bot
    build:
      context: .
      dockerfile: ./apps/bot/Containerfile
    depends_on:
      volume-init:
        condition: service_completed_successfully
    restart: unless-stopped
    environment:
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    volumes:
      - hjaerna-data:/app/data
    networks:
      - traefik
    labels:
      - traefik.enable=true
      - traefik.http.routers.hjaerna-bot.entrypoints=http
      - traefik.http.routers.hjaerna-bot.rule=Host(`bot.dreitagebart.io`)
      - traefik.http.services.hjaerna-bot.loadbalancer.server.port=3000
      - traefik.http.routers.hjaerna-bot.middlewares=traefik-https-redirect
      - traefik.http.routers.hjaerna-bot-secure.entrypoints=https
      - traefik.http.routers.hjaerna-bot-secure.rule=Host(`bot.dreitagebart.io`)
      - traefik.http.routers.hjaerna-bot-secure.tls=true
      - traefik.http.routers.hjaerna-bot-secure.tls.certresolver=cloudflare
      - traefik.http.routers.hjaerna-bot-secure.service=hjaerna-bot

  web:
    container_name: hjaerna-web
    build:
      context: .
      dockerfile: ./apps/web/Containerfile
    restart: unless-stopped
    volumes:
      - hjaerna-data:/app/apps/web/public/data:ro
    networks:
      - traefik
    labels:
      - traefik.enable=true
      - traefik.http.routers.hjaerna-web.entrypoints=http
      - traefik.http.routers.hjaerna-web.rule=Host(`brain.dreitagebart.io`)
      - traefik.http.services.hjaerna-web.loadbalancer.server.port=3000
      - traefik.http.routers.hjaerna-web.middlewares=traefik-https-redirect
      - traefik.http.routers.hjaerna-web-secure.entrypoints=https
      - traefik.http.routers.hjaerna-web-secure.rule=Host(`brain.dreitagebart.io`)
      - traefik.http.routers.hjaerna-web-secure.tls=true
      - traefik.http.routers.hjaerna-web-secure.tls.certresolver=cloudflare
      - traefik.http.routers.hjaerna-web-secure.service=hjaerna-web

  sync:
    image: syncthing/syncthing:2.0.13
    container_name: hjaerna-sync
    hostname: hjaerna
    depends_on:
      volume-init:
        condition: service_completed_successfully
    environment:
      - PUID=1001
      - PGID=1001
    volumes:
      - hjaerna-data:/var/syncthing/data
      # - ./config:/var/syncthing/config
    ports:
      # - 8384:8384
      - 22000:22000/tcp
      - 22000:22000/udp
      # - 21027:21027/udp
    cap_add:
      - CHOWN
      - FOWNER
    restart: unless-stopped
    networks:
      - traefik
    labels:
      - traefik.enable=true
      - traefik.http.routers.hjaerna-sync.entrypoints=http
      - traefik.http.routers.hjaerna-sync.rule=Host(`sync.dreitagebart.io`)
      - traefik.http.services.hjaerna-sync.loadbalancer.server.port=8384
      - traefik.http.routers.hjaerna-sync.middlewares=traefik-https-redirect
      - traefik.http.routers.hjaerna-sync-secure.entrypoints=https
      - traefik.http.routers.hjaerna-sync-secure.rule=Host(`sync.dreitagebart.io`)
      - traefik.http.routers.hjaerna-sync-secure.tls=true
      - traefik.http.routers.hjaerna-sync-secure.tls.certresolver=cloudflare
      - traefik.http.routers.hjaerna-sync-secure.service=hjaerna-sync


networks:
  traefik:
    external: true

volumes:
  hjaerna-data:
    external: true
